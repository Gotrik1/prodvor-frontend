name: Sync backend & frontend to local PC via Tailscale

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Install & Connect to Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --accept-routes=true
          tailscale status

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.TAILSCALE_HOST }}" >> ~/.ssh/known_hosts

      # ===== FRONTEND (CMD) =====
      - name: Pull FRONTEND repo (CMD)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            cmd /c ^
            "cd /d E:\prodvor\frontend ^
            && echo == FRONTEND == ^
            && whoami ^
            && git rev-parse --show-toplevel ^
            && git remote -v ^
            && git fetch --all --prune ^
            && git reset --hard origin/main ^
            && git log -1 --oneline ^
            && echo âœ… FRONTEND synced"
