name: Build backend & frontend on remote (PROD, logs)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

concurrency:
  group: prod-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prod-build:
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_LOGLEVEL: verbose
      CI: "true"

    steps:
      - name: ðŸ›°ï¸ Install & Connect to Tailscale
        run: |
          set -euxo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" \
            --accept-routes=true \
            --ssh=true
          tailscale status || true
          tailscale ip -4

      - name: ðŸ”‘ Trust host key
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.TAILSCALE_HOST }}" >> ~/.ssh/known_hosts
          echo "Known hosts OK"

      # ===== Log dir =====
      - name: ðŸ—‚ï¸ Prepare timestamped log folder (remote, PowerShell)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            $ErrorActionPreference = "Stop"
            $stamp   = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
            $logRoot = "E:\prodvor\logs"
            $logDir  = Join-Path $logRoot $stamp
            if (-not (Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir | Out-Null }
            Set-Content -Path (Join-Path $logRoot "_latest_dir.txt") -Value $logDir -Encoding ASCII
            Write-Host "== Log dir: $logDir"
            Get-Content (Join-Path $logRoot "_latest_dir.txt")

      # ===== FRONTEND build only =====
      - name: ðŸŒ FRONTEND â€” production build (no git, verbose)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            $ErrorActionPreference = "Stop"
            $root   = "E:\prodvor\frontend"
            $logDir = Get-Content "E:\prodvor\logs\_latest_dir.txt"
            $envLog   = Join-Path $logDir "frontend-env.log"
            $npmCiLog = Join-Path $logDir "frontend-npm-ci.log"
            $buildLog = Join-Path $logDir "frontend-build.log"

            Write-Host "== FRONTEND build =="
            whoami | Tee-Object -FilePath $envLog
            $PSVersionTable | Out-String | Tee-Object -FilePath $envLog -Append
            try { node -v | Tee-Object -FilePath $envLog -Append } catch { "node not in PATH" | Tee-Object -FilePath $envLog -Append }
            try { npm -v  | Tee-Object -FilePath $envLog -Append } catch { "npm not in PATH"  | Tee-Object -FilePath $envLog -Append }

            Set-Location $root

            Write-Host "---- npm ci ----"
            $env:NODE_OPTIONS="--max-old-space-size=4096"
            npm ci --verbose 2>&1 | Tee-Object -FilePath $npmCiLog

            Write-Host "---- npm run build (prod) ----"
            $env:NEXT_TELEMETRY_DISABLED="1"
            $env:TURBO_TELEMETRY_DISABLED="1"
            npm run build --verbose 2>&1 | Tee-Object -FilePath $buildLog

            Write-Host "âœ… FRONTEND: done"
            Write-Host "Logs:"
            Write-Host " - $envLog"
            Write-Host " - $npmCiLog"
            Write-Host " - $buildLog"

            # OPTIONAL: restart service if needed
            # pm2 restart prodvor-frontend
            # nssm restart prodvor-frontend
            # docker compose -f E:\prodvor\frontend\docker-compose.yml up -d --build
