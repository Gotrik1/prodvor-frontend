name: Sync & Build (backend + frontend) via Tailscale ‚Äî PROD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

concurrency:
  group: prod-sync-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prod-sync-build:
    runs-on: ubuntu-latest
    env:
      # –í–∫–ª—é—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è npm/Node
      NPM_CONFIG_LOGLEVEL: verbose
      CI: "true"

    steps:
      - name: üõ∞Ô∏è Install & Connect to Tailscale
        run: |
          set -euxo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" \
            --accept-routes=true \
            --ssh=true
          echo "== tailscale status =="
          tailscale status
          echo "== my tailscale ip =="
          tailscale ip -4

      - name: üîë Trust host key
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.TAILSCALE_HOST }}" >> ~/.ssh/known_hosts
          echo "Known hosts:"
          cat ~/.ssh/known_hosts

      - name: üóÇÔ∏è Prepare log folder on remote (timestamped)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            for /f "tokens=1-5 delims=/ " %%a in ('date /t') do set dt=%%c-%%a-%%b
            for /f "tokens=1 delims=." %%a in ('echo %time%') do set tm=%%a
            set tm=%tm::=-%
            set STAMP=%dt%_%tm%
            set LOGDIR=E:\prodvor\logs\%STAMP%
            echo == Creating log dir: %LOGDIR%
            if not exist "%LOGDIR%" mkdir "%LOGDIR%"
            echo %LOGDIR%>E:\prodvor\logs\_latest_dir.txt
            type E:\prodvor\logs\_latest_dir.txt

      # ===================== FRONTEND =====================
      - name: üåê FRONTEND ‚Äî git sync & build (verbose)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            setlocal enabledelayedexpansion
            set ROOT=E:\prodvor\frontend
            set LATEST_FILE=E:\prodvor\logs\_latest_dir.txt
            set /p LOGDIR=<%LATEST_FILE%
            set GITLOG=%LOGDIR%\frontend-git.log
            set NPMCI_LOG=%LOGDIR%\frontend-npm-ci.log
            set BUILD_LOG=%LOGDIR%\frontend-build.log

            echo == FRONTEND == & echo.
            echo ## whoami && whoami
            echo ## ver && ver
            echo ## node -v && node -v 2>&1
            echo ## npm -v && npm -v 2>&1
            echo.

            cd /d %ROOT%

            echo ---- GIT REMOTE INFO ---- | tee %GITLOG%
            git rev-parse --show-toplevel 2>&1 | tee -a %GITLOG%
            git remote -v 2>&1            | tee -a %GITLOG%
            echo ---- FETCH & RESET ----   | tee -a %GITLOG%
            git fetch --all --prune 2>&1   | tee -a %GITLOG%
            git reset --hard origin/main 2>&1 | tee -a %GITLOG%
            git log -1 --oneline 2>&1      | tee -a %GITLOG%

            echo. & echo ---- FOLDER SIZES BEFORE BUILD ----
            dir /-c
            echo.

            echo ---- NPM CI (verbose) ----
            set "NODE_OPTIONS=--max-old-space-size=4096"
            npm ci --verbose 2>&1 | tee %NPMCI_LOG%

            echo ---- BUILD (production) ----
            set NEXT_TELEMETRY_DISABLED=1
            set TURBO_TELEMETRY_DISABLED=1
            npm run build --verbose 2>&1 | tee %BUILD_LOG%

            echo. & echo ---- FOLDER SIZES AFTER BUILD ----
            dir /-c
            echo.
            echo ‚úÖ FRONTEND build finished. Logs:
            echo  - %GITLOG%
            echo  - %NPMCI_LOG%
            echo  - %BUILD_LOG%

            rem === OPTIONAL: restart frontend service ===
            rem pm2 restart prodvor-frontend
            rem nssm restart prodvor-frontend
            rem docker compose -f E:\prodvor\frontend\docker-compose.yml up -d --build
