name: Deploy frontend to local PC via Tailscale

on:
  push:
    branches: [ "main" ]

# права воркфлоу (минимально нужные)
permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) чекаут — нужен хотя бы для метаданных/логов
      - name: Checkout
        uses: actions/checkout@v4

      # 2) подключаем runner к твоему tailnet (как временному клиенту)
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: stable

      # 3) доверяем host key, чтобы ssh не спрашивал "Are you sure?"
      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TAILSCALE_HOST }} >> ~/.ssh/known_hosts

      # 4) основное: зайти по ssh на твой ПК и обновить фронт
      - name: Pull & restart frontend on Windows host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key: ${{ secrets.TAILSCALE_SSH_KEY }}
          port: 22
          # если у тебя нет pnpm на ПК — оставь как есть: шаг сам упадёт на pnpm и продолжит npm
          script: |
            REM ====== ПУТИ ======
            cd /d E:\prodvor\frontend

            REM ====== GIT СИНХ ======
            git fetch --all --prune
            git reset --hard origin/main

            REM ====== ЗАВИСИМОСТИ ======
            if exist pnpm-lock.yaml (
              pnpm -v >NUL 2>&1 && pnpm install --frozen-lockfile || npm install --no-audit --no-fund
            ) else (
              npm install --no-audit --no-fund
            )

            REM ====== ПЕРЕЗАПУСК (ВЫБЕРИ ОДНО) ======

            REM [A] Dev-скрипт (как есть)
            taskkill /im node.exe /f >NUL 2>&1
            start "" cmd /c "pnpm run dev || npm run dev"

            REM [B] PM2 (раскомментируй и настрой ecosystem.config.js)
            REM npx pm2 startOrReload ecosystem.config.js --only frontend

            REM [C] Docker Compose из корня монорепы
            REM cd /d E:\prodvor
            REM docker compose pull
            REM docker compose up -d --build
