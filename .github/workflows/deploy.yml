name: Build frontend on remote (PROD)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_LOGLEVEL: verbose
      CI: "true"

    steps:
      - name: Install & connect Tailscale
        run: |
          set -euxo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" \
            --accept-routes=true \
            --ssh=true
          tailscale status || true

      - name: Trust host key
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.TAILSCALE_HOST }}" >> ~/.ssh/known_hosts

      - name: Prepare log folder (remote)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ^
            "$ErrorActionPreference='Stop'; ^
             $stamp   = Get-Date -Format 'yyyy-MM-dd_HH-mm-ss'; ^
             $logRoot = 'E:\prodvor\logs'; ^
             $logDir  = Join-Path $logRoot $stamp; ^
             if (-not (Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir | Out-Null }; ^
             Set-Content -Path (Join-Path $logRoot '_latest_dir.txt') -Value $logDir -Encoding ASCII; ^
             Write-Host ('Log dir: ' + $logDir)"

      - name: FRONTEND — npm ci & build (remote)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ^
            "$ErrorActionPreference='Stop'; ^
             [Console]::OutputEncoding=[Text.UTF8Encoding]::new(); ^
             $root    = 'E:\prodvor\frontend'; ^
             $logDir  = Get-Content 'E:\prodvor\logs\_latest_dir.txt'; ^
             $envLog  = Join-Path $logDir 'frontend-env.log'; ^
             $npmLog  = Join-Path $logDir 'frontend-npm-ci.log'; ^
             $buildLog= Join-Path $logDir 'frontend-build.log'; ^
             Write-Host '== FRONTEND build =='; ^
             whoami            | Tee-Object -FilePath $envLog; ^
             try { node -v     | Tee-Object -FilePath $envLog -Append } catch { 'node not in PATH' | Tee-Object -FilePath $envLog -Append }; ^
             try { npm  -v     | Tee-Object -FilePath $envLog -Append } catch { 'npm not in PATH'  | Tee-Object -FilePath $envLog -Append }; ^
             Set-Location $root; ^
             $env:NODE_OPTIONS='--max-old-space-size=4096'; ^
             Write-Host 'npm ci'; ^
             npm ci --verbose 2>&1 | Tee-Object -FilePath $npmLog; ^
             Write-Host 'npm run build'; ^
             $env:NEXT_TELEMETRY_DISABLED='1'; ^
             $env:TURBO_TELEMETRY_DISABLED='1'; ^
             npm run build --verbose 2>&1 | Tee-Object -FilePath $buildLog; ^
             Write-Host '✅ FRONTEND done'; ^
             Write-Host ('Logs:' + [Environment]::NewLine + ' - ' + $envLog + [Environment]::NewLine + ' - ' + $npmLog + [Environment]::NewLine + ' - ' + $buildLog)"

      - name: Show log directory (remote)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ^
            "$logDir = Get-Content 'E:\prodvor\logs\_latest_dir.txt'; ^
             Write-Host ('Latest logs: ' + $logDir); ^
             Get-ChildItem -Force $logDir | Format-Table -AutoSize Name,Length,CreationTime"
