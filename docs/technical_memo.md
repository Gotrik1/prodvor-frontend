
# Техническая памятка по интеграции с бэкендом (ProDvor)

**ВАЖНО:** Этот документ содержит подтвержденные и работающие решения по интеграции с бэкендом. Не изменять описанную здесь логику без крайней необходимости.

---

## 1. Сетевое соединение и CORS

- **Статус:** **Решено и стабильно.**
- **URL бэкенда:** Адрес хранится в переменной `NEXT_PUBLIC_API_BASE_URL` в файле `.env` и использует протокол `https://`.
- **CORS:** Настроен на стороне бэкенда (`access-control-allow-origin: *`). Проблем с CORS нет.
- **Действие:** **Не изменять** сетевые настройки, URL бэкенда или `next.config.ts` в попытках "исправить" сетевые ошибки. Проблема, скорее всего, в другом.

---

## 2. Логика авторизации

- **Статус:** **Решено.**
- **Эндпоинт:** `POST /api/v1/auth/login`
- **Логика:** Бэкенд возвращает **единый JSON-объект**, содержащий `accessToken`, `refreshToken` и полный объект `user`.
    ```json
    {
      "accessToken": "ey...",
      "refreshToken": "ey...",
      "user": { ... }
    }
    ```
- **Действие:** Фронтенд **не делает** дополнительный запрос на `/api/v1/users/me` после логина. Данные пользователя берутся напрямую из ответа `/api/v1/login`.

---

## 3. Данные о командах пользователя

- **Статус:** **Обновлено. Требуется внимание бэкенда.**
- **Эндпоинт:** `GET /api/v1/users/me?include_teams=true`
- **Логика:** Для виджета "Мои команды" фронтенд делает запрос на получение данных текущего пользователя с параметром `include_teams=true`. Ответ от бэкенда **должен содержать** полный массив объектов команд, в которых состоит пользователь, прямо внутри объекта `user` в поле `teams`.
- **Пример ожидаемого ответа:**
    ```json
    {
      "id": 1,
      "nickname": "PlayerOne",
      "email": "player@one.com",
      // ... другие поля пользователя
      "teams": [
        {
          "id": 10,
          "name": "Team Alpha",
          "logoUrl": "https://...",
          "sport": { "id": "sport-1", "name": "Футбол" },
          "rank": 1500
          // ... другие поля команды
        },
        {
          "id": 12,
          "name": "Team Beta",
          "logoUrl": "https://...",
          "sport": { "id": "sport-2", "name": "Баскетбол" },
          "rank": 1450
        }
      ]
    }
    ```
- **Действие для бэкенда:** Убедиться, что эндпоинт `GET /users/me` при наличии `include_teams=true` возвращает именно такую структуру, включая массив **полных объектов** команд, а не просто их ID.

---

## 4. Данные о дисциплинах пользователя

- **Статус:** **Решено.**
- **Источник данных:** Дисциплины пользователя **уже содержатся** в объекте `user`, который приходит с бэкенда.
- **Название поля:** Поле называется `sports`.
- **Структура:** Это массив объектов вида `{ id: string, name: string }`.
    ```json
    "sports": [
      { "id": "sport-1", "name": "Футбол" },
      { "id": "sport-2", "name": "Баскетбол" }
    ]
    ```
- **Действие:** **Не делать** отдельный запрос на `/api/sports` для получения дисциплин пользователя. Вместо этого, извлекать данные из поля `user.sports`.

---

## 5. Загрузка файлов (Аватары, Логотипы)

- **Статус:** **Решено. Используется новая 3-шаговая система.**
- **Описание:** Для загрузки файлов используется система с presigned URL, что позволяет клиенту загружать файлы напрямую в облачное хранилище, минуя бэкенд. Это повышает скорость и надежность загрузки.
- **Действие:** **Всегда** использовать 3-шаговую систему для загрузки файлов. Подробное описание механизма находится в **[Руководстве по загрузке файлов](/admin/docs?tab=uploads_guide)**.

---

## 6. Конфигурация Next.js (`next.config.js`)

- **Статус:** **Критически важно.**
- **Изображения:** Все внешние домены, с которых загружаются изображения через компонент `<Image>`, **должны быть** явно перечислены в секции `images.remotePatterns` в файле `next.config.js`.
    ```javascript
    // next.config.js
    const nextConfig = {
      images: {
        remotePatterns: [
          {
            protocol: 'https',
            hostname: 'storage.googleapis.com',
          },
          // ... другие хосты
        ],
      },
    };
    ```
- **Перезапуск сервера:** **ВАЖНО!** Любые изменения в файле `next.config.js` вступают в силу **только после полного перезапуска** сервера разработки. Горячая перезагрузка (Fast Refresh) не считывает этот файл заново. Если вы добавили домен, но продолжаете видеть ошибку `Error: Invalid src prop`, в первую очередь перезапустите сервер.

---

## 7. Управление сессиями (Multi-device login)

- **Статус:** **Реализовано (требует бэкенд).**
- **Проблема:** Пользователя "выкидывало" из старой сессии при входе с нового устройства.
- **Решение:** Внедрена архитектура для поддержки нескольких одновременных сессий.
    - **Бэкенд:** Должен хранить каждую сессию (`refreshToken`) в отдельной таблице `UserSessions`. Подробности реализации см. в промпте для бэкенда.
    - **Фронтенд:** В настройках аккаунта (`/settings`, вкладка "Аккаунт") добавлен новый раздел "Активные сессии". Пользователь может просматривать все устройства, где выполнен вход, и принудительно завершать любую сессию.
- **Действие:** Реализовать на бэкенде эндпоинты `GET /api/v1/users/me/sessions` и `DELETE /api/v1/users/me/sessions/<id>` согласно спецификации.
