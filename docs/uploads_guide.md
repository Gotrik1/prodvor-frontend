# Руководство по загрузке файлов в ProDvor

Этот документ описывает **новую, двухшаговую систему** для загрузки файлов (аватаров, логотипов, баннеров) на платформу. Эта система используется для всех загрузок пользовательского контента и является обязательной к применению.

**Цель:** Снизить нагрузку на наш бэкенд, увеличить скорость и надежность загрузки для пользователя, делегировав процесс хранения файлов специализированному облачному хранилищу (S3-совместимому, например, MinIO).

---

## Принцип работы

Процесс загрузки файла состоит из трех последовательных этапов:

1.  **Инициация загрузки:** Фронтенд сообщает бэкенду о намерении загрузить файл, указывая его тип и назначение. Бэкенд в ответ предоставляет временную, одноразовую "подписанную ссылку" (presigned URL) для прямой загрузки в S3 и уникальный `fileId`.
2.  **Прямая загрузка в хранилище:** Фронтенд, используя полученный URL, отправляет файл **напрямую** в облачное хранилище, минуя наш бэкенд.
3.  **Завершение загрузки:** После успешной загрузки в хранилище, фронтенд отправляет `fileId` на бэкенд, чтобы тот связал загруженный файл с нужной сущностью (профилем пользователя, командой и т.д.).

## Шаг 1: Инициация загрузки (Presigned URL)

-   **Эндпоинт:** `POST /api/v1/uploads/initiate`
-   **Метод:** `POST`
-   **Заголовки:**
    -   `Content-Type: application/json`
    -   `Authorization: Bearer <access_token>`
-   **Тело запроса (JSON):**
    ```json
    {
      "contentType": "image/jpeg",
      "purpose": "avatar"
    }
    ```
    -   **`contentType`**: MIME-тип файла.
    -   **`purpose`**: Назначение файла (например, `avatar`, `team_logo`, `post_attachment`).

#### Пример ответа от бэкенда (успех)

```json
{
    "url": "https://minio.prodvor.website/prodvor-bucket/...",
    "fields": { ... },
    "fileId": "unique-file-identifier-123"
}
```
-   **`url`**: Адрес, куда нужно будет отправлять файл.
-   **`fields`**: Объект с полями, которые нужно добавить в `FormData` для аутентификации запроса к хранилищу.
-   **`fileId`**: Уникальный идентификатор, который нужно сохранить для Шага 3.

---

## Шаг 2: Прямая загрузка в хранилище

Используя данные из Шага 1, нужно сформировать `FormData` и отправить файл напрямую в облако.

```typescript
const file = // ... ваш объект файла из <input>
const { url, fields, fileId } = // ... данные из ответа на Шаг 1

const formData = new FormData();

// Добавляем все поля, которые нам дал бэкенд
Object.entries(fields).forEach(([key, value]) => {
  formData.append(key, value as string);
});

// ВАЖНО: поле с файлом должно быть последним
formData.append('file', file);

// Отправляем запрос НАПРЯМУЮ в хранилище
const uploadResponse = await fetch(url, {
  method: 'POST',
  body: formData,
});

if (!uploadResponse.ok) {
  // Обработка ошибки загрузки
  return;
}
```

---

## Шаг 3: Завершение загрузки

После успешной загрузки, уведомите бэкенд, связав `fileId` с нужной сущностью.

-   **Эндпоинт:** `POST /api/v1/uploads/complete`
-   **Метод:** `POST`
-   **Заголовки:**
    -   `Content-Type: application/json`
    -   `Authorization: Bearer <access_token>`
-   **Тело запроса (JSON):**
    ```json
    {
      "fileId": "unique-file-identifier-123",
      "entityType": "user_avatar",
      "entityId": "user-id-abc"
    }
    ```
    - **`entityType`**: `user_avatar` или `team_logo`.
    - **`entityId`**: ID пользователя или команды.

#### Пример ответа от бэкенда (успех)

Бэкенд вернет сообщение об успехе и финальный URL файла.

```json
{
    "success": true,
    "url": "https://minio.prodvor.website/prodvor-bucket/users/abc/avatar.jpg"
}
```

После этого можно обновлять UI.
