# Руководство по загрузке файлов в ProDvor

Этот документ описывает **новую, трехшаговую систему** для загрузки файлов (аватаров, логотипов, баннеров) на платформу. Эта система используется для всех загрузок пользовательского контента и является обязательной к применению.

**Цель:** Снизить нагрузку на наш бэкенд, увеличить скорость и надежность загрузки для пользователя, делегировав процесс хранения файлов специализированному облачному хранилищу (S3-совместимому, например, MinIO).

---

## Принцип работы

Процесс загрузки файла состоит из трех последовательных этапов:

1.  **Запрос разрешения на загрузку:** Фронтенд отправляет метаданные о файле (его тип) на наш бэкенд и получает в ответ временную, одноразовую "подписанную ссылку" (presigned URL) и набор полей.
2.  **Прямая загрузка в хранилище:** Фронтенд, используя полученные URL и поля, отправляет файл **напрямую** в облачное хранилище, минуя наш бэкенд.
3.  **Уведомление об успехе:** После успешной загрузки в хранилище, фронтенд отправляет финальный URL файла на наш бэкенд, чтобы тот сохранил эту ссылку в базе данных (например, в профиле пользователя или команды).

## Шаг 1: Запрос разрешения (Presigned URL)

Когда пользователь выбирает файл для загрузки, фронтенд должен сделать запрос на наш бэкенд.

-   **Эндпоинт:** `POST /api/v1/uploads/request-url`
-   **Метод:** `POST`
-   **Заголовки:**
    -   `Content-Type: application/json`
    -   `Authorization: Bearer <access_token>`
-   **Тело запроса (JSON):**
    ```json
    {
      "contentType": "image/jpeg"
    }
    ```
    -   **`contentType`**: **Обязательное поле.** Это MIME-тип выбранного файла. Его нужно брать из объекта файла, который вы получаете из input'а (`file.type`). Бэкенд проверяет этот тип и может отказать, если это не изображение.

#### Пример ответа от бэкенда (успех, 200 OK)

```json
{
    "url": "https://minio.prodvor.website/prodvor-bucket",
    "fields": {
        "Content-Type": "image/jpeg",
        "key": "users/123/uploads/abcd1234unique.jpg",
        "AWSAccessKeyId": "...",
        "policy": "...",
        "signature": "..."
    },
    "fileUrl": "https://minio.prodvor.website/prodvor-bucket/users/123/uploads/abcd1234unique.jpg"
}
```

-   **`url`**: Адрес, куда нужно будет отправлять файл.
-   **`fields`**: Объект с полями, которые **обязательно** нужно добавить в `FormData` для аутентификации запроса к хранилищу.
-   **`fileUrl`**: Финальный публичный URL файла после загрузки. Его нужно сохранить для Шага 3.

---

## Шаг 2: Прямая загрузка в хранилище

Теперь, имея данные из Шага 1, нужно сформировать `FormData` и отправить файл напрямую в облако.

1.  **Создайте `FormData`:**
    `const formData = new FormData();`

2.  **Добавьте все поля из `fields`:** Переберите в цикле объект `fields` и добавьте каждую пару ключ-значение.

3.  **Добавьте файл ПОСЛЕДНИМ:** Это критически важно для некоторых S3-совместимых хранилищ. Поле должно называться `"file"`.

4.  **Отправьте запрос:**
    -   **Эндпоинт:** Значение из поля `url` ответа Шага 1.
    -   **Метод:** `POST`
    -   **Заголовки:** Никаких специальных заголовков! **Не добавляйте `Authorization`!** Браузер сам выставит правильный `Content-Type: multipart/form-data` с нужным `boundary`.
    -   **Тело запроса:** Ваш объект `FormData`.

#### Пример кода (JavaScript/TypeScript)

```typescript
const file = // ... ваш объект файла из <input type="file">
const { url, fields, fileUrl } = // ... данные из ответа на Шаг 1

const formData = new FormData();

// Добавляем все поля, которые нам дал бэкенд
Object.entries(fields).forEach(([key, value]) => {
  formData.append(key, value as string);
});

// ВАЖНО: поле с файлом должно быть последним
formData.append('file', file);

// Отправляем запрос НАПРЯМУЮ в хранилище (MinIO/S3)
const uploadResponse = await fetch(url, {
  method: 'POST',
  body: formData,
});

if (!uploadResponse.ok) {
  // Если S3 вернул ошибку, обработайте ее
  console.error('Ошибка прямой загрузки файла!');
  return;
}
```

Если `uploadResponse.ok` равен `true`, значит файл успешно загружен в облако.

---

## Шаг 3: Уведомление бэкенда об успехе

После успешной загрузки в хранилище, нужно сообщить нашему бэкенду, что все прошло хорошо и он может сохранить ссылку на файл.

Для этого используется URL, полученный на Шаге 1 (поле **`fileUrl`**), и соответствующий эндпоинт для сущности, которую вы обновляете.

#### Пример для аватара пользователя:

-   **Эндпоинт:** `POST /api/v1/users/avatar`
-   **Метод:** `POST`
-   **Заголовки:**
    -   `Content-Type: application/json`
    -   `Authorization: Bearer <access_token>`
-   **Тело запроса (JSON):**
    ```json
    {
      "fileUrl": "https://minio.prodvor.website/prodvor-bucket/users/123/uploads/abcd1234unique.jpg"
    }
    ```

#### Пример для логотипа команды:

-   **Эндпоинт:** `POST /api/v1/teams/:teamId/logo`
-   **Метод:** `POST`
-   **Заголовки:**
    -   `Content-Type: application/json`
    -   `Authorization: Bearer <access_token>`
-   **Тело запроса (JSON):**
    ```json
    {
      "fileUrl": "https://minio.prodvor.website/prodvor-bucket/teams/abc/logos/xyz.png"
    }
    ```

#### Пример ответа от бэкенда (успех, 200 OK)

Бэкенд вернет обновленную сущность или сообщение об успехе.

```json
// Для аватара
{
    "message": "Аватар успешно обновлен",
    "user": { ... обновленный объект пользователя ... }
}

// Для логотипа
{
    "message": "Логотип успешно обновлен",
    "logoUrl": "https://..."
}
```

После получения этого ответа можно обновлять UI, чтобы показать пользователю новый аватар или логотип.
