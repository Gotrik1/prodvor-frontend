# Руководство по настройке MinIO для ProDvor

Этот документ описывает, как поднять и настроить локальное S3-совместимое хранилище MinIO с помощью Docker, чтобы обеспечить работу новой системы загрузки файлов.

---

## Шаг 1: Установка Docker

Если у вас еще не установлен Docker, скачайте и установите его с официального сайта: [https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/)

---

## Шаг 2: Создание файла `docker-compose.yml`

Создайте в корне вашего проекта (или в любом удобном месте) файл с именем `docker-compose.yml` и скопируйте в него следующее содержимое:

```yaml
version: '3.8'

services:
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: prodvor-minio-storage
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console Port
    environment:
      # ВАЖНО: Замените на свои надежные значения
      MINIO_ROOT_USER: 'YOUR_MINIO_ACCESS_KEY'
      MINIO_ROOT_PASSWORD: 'YOUR_MINIO_SECRET_KEY'
    volumes:
      - ./minio-data:/data # Сохраняет данные на вашем локальном диске

networks:
  default:
    name: prodvor-network
```

**Критически важно:**
- Замените `'YOUR_MINIO_ACCESS_KEY'` на ваш собственный ключ доступа. Это может быть любая строка, например, `prodvoradmin`.
- Замените `'YOUR_MINIO_SECRET_KEY'` на ваш собственный секретный ключ. Это должна быть сложная и длинная строка, например, `prodvorsecretkey12345`.
- **Сохраните эти значения!** Они понадобятся вам на Шаге 5.

---

## Шаг 3: Запуск MinIO

1.  Откройте терминал или командную строку.
2.  Перейдите в директорию, где вы создали файл `docker-compose.yml`.
3.  Выполните команду:
    ```bash
    docker-compose up -d
    ```
    Флаг `-d` (detached) запустит контейнер в фоновом режиме.

После выполнения команды Docker скачает образ MinIO и запустит контейнер. Хранилище станет доступно по адресам:
- **API:** `http://localhost:9000`
- **Веб-консоль:** `http://localhost:9001`

---

## Шаг 4: Настройка бакета (Bucket)

Теперь нужно создать "ведро" (бакет) для хранения наших файлов и сделать его публичным для чтения.

1.  **Откройте веб-консоль:** Перейдите в браузере по адресу [http://localhost:9001](http://localhost:9001).
2.  **Войдите в систему:** Используйте **Access Key** и **Secret Key**, которые вы указали в `docker-compose.yml` на Шаге 2.
3.  **Создайте бакет:**
    *   Нажмите на кнопку "Create Bucket".
    *   Введите имя бакета. Давайте назовем его **`prodvor-bucket`**. Это имя мы будем использовать в бэкенде.
    *   Остальные настройки оставьте по умолчанию и нажмите "Create Bucket".
4.  **Настройте политику доступа:**
    *   Перейдите в раздел "Buckets" в левом меню.
    *   Найдите ваш `prodvor-bucket` и нажмите на кнопку "Manage".
    *   Перейдите на вкладку "Access Policy".
    *   Установите значение **`public`**. Это позволит фронтенду отображать загруженные изображения без дополнительной аутентификации.

---

## Шаг 5: Конфигурация Python-бэкенда

Теперь нужно сообщить вашему Python/Flask бэкенду, как подключаться к MinIO.

1.  **Установите зависимость:** Убедитесь, что в вашем `requirements.txt` (или виртуальном окружении) установлен пакет `minio`:
    ```bash
    pip install minio
    ```
2.  **Добавьте переменные окружения:** В файле, где вы храните конфигурацию бэкенда (например, `.env` или прямо в коде для локальной разработки), добавьте следующие переменные:

    ```
    MINIO_ENDPOINT="localhost:9000"
    MINIO_ACCESS_KEY="YOUR_MINIO_ACCESS_KEY"  # Тот же, что в docker-compose.yml
    MINIO_SECRET_KEY="YOUR_MINIO_SECRET_KEY"  # Тот же, что в docker-compose.yml
    MINIO_BUCKET_NAME="prodvor-bucket"        # Имя, которое вы задали на Шаге 4
    MINIO_SECURE=False                        # Используем http, а не https для локальной разработки
    ```
3.  **Обновите код бэкенда:** Убедитесь, что ваш бэкенд считывает эти переменные и использует их при инициализации клиента MinIO. Код, который генерирует presigned URL, должен использовать именно эти параметры.

**Пример инициализации клиента MinIO в Python:**

```python
from minio import Minio
import os

minio_client = Minio(
    os.getenv("MINIO_ENDPOINT"),
    access_key=os.getenv("MINIO_ACCESS_KEY"),
    secret_key=os.getenv("MINIO_SECRET_KEY"),
    secure=os.getenv("MINIO_SECURE", "False").lower() == "true"
)
```

---

## Завершение

После выполнения этих шагов ваш локальный стек полностью готов к работе:
- Фронтенд запрашивает разрешение у бэкенда.
- Бэкенд, зная параметры MinIO, генерирует presigned URL.
- Фронтенд загружает файл напрямую в MinIO.
- Бэкенд сохраняет финальную ссылку.

Теперь функция загрузки аватаров и логотипов должна работать корректно.
