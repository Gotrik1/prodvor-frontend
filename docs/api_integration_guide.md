# ProDvor: Руководство по интеграции с API

Этот документ объединяет всю необходимую информацию для фронтенд-разработчиков по работе с бэкендом ProDvor.

---

## 1. Основы взаимодействия

- **Базовый URL:** Адрес бэкенда хранится в переменной `NEXT_PUBLIC_API_BASE_URL` в файле `.env`. Все запросы должны использовать префикс `/api/v1/`.
- **CORS:** Настроен на стороне бэкенда. Проблем быть не должно.
- **SDK:** Для всех запросов к API используется автоматически сгенерированный клиент, находящийся в `src/shared/api`. Он предоставляет типобезопасные классы (`UsersApi`, `TeamsApi`, и т.д.) и модели данных.
- **Обновление SDK:** При изменении API на бэкенде необходимо обновить локальный `openapi.json` и перегенерировать клиент командой:
  ```bash
  npx openapi-generator-cli generate
  ```
- **Axios Instance:** Глобальный экземпляр `axios` в `src/shared/api/axios-instance.ts` автоматически управляет добавлением JWT-токенов и их обновлением (refresh).

---

## 2. Авторизация и Управление сессиями

### 2.1. Логин

- **Эндпоинт:** `POST /api/v1/auth/login`
- **Логика:** Бэкенд возвращает **единый JSON-объект**, содержащий `accessToken`, `refreshToken` и полный объект `user`.
    ```json
    {
      "accessToken": "ey...",
      "refreshToken": "ey...",
      "user": { ... }
    }
    ```
- **Действие:** Фронтенд **не делает** дополнительный запрос на `/api/v1/users/me` после логина. Данные пользователя и токены сохраняются в `useUserStore`.

### 2.2. Управление сессиями

- **Эндпоинт:** `GET /api/v1/users/me/sessions`
- **Логика:** Для отображения списка активных сессий (например, в настройках безопасности) фронтенд делает запрос на этот эндпоинт. Бэкенд возвращает массив сессий, помечая текущую флагом `isCurrent: true`.

---

## 3. Загрузка Файлов (Presigned URL)

Для загрузки файлов (аватары, логотипы) используется **двухшаговая система**, чтобы снизить нагрузку на бэкенд и увеличить скорость.

1.  **`POST /api/v1/uploads/initiate`**: Фронтенд запрашивает разрешение на загрузку, отправляя тип контента и назначение файла (например, `avatar` или `team_logo`). Бэкенд возвращает presigned URL для прямой загрузки в S3-хранилище.
2.  **`POST /api/v1/uploads/complete`**: После успешной загрузки файла в S3, фронтенд уведомляет бэкенд, отправляя URL загруженного файла. Бэкенд связывает этот URL с соответствующей сущностью (пользователем или командой).

**Важно:** Для локальной разработки необходимо настроить и запустить MinIO через Docker. Инструкции находятся в `docs/minio_setup_guide.md`.

---

## 4. Получение данных для профилей

### 4.1. Профиль пользователя

- **Эндпоинт:** `GET /api/v1/users/{user_id}` или `GET /api/v1/users/me`.
- **Параметр:** `?include_teams=true`
- **Логика:** Для получения данных пользователя вместе с его командами всегда используйте параметр `include_teams=true`. Бэкенд вернет объект `user` со встроенным массивом `teams`.
- **Пример ожидаемого ответа:**
    ```json
    {
      "id": "user-1",
      "nickname": "PlayerOne",
      // ... другие поля пользователя
      "player_profile": { ... },
      "teams": [
        { "id": "team-1", "name": "Team Alpha", "logoUrl": "..." },
        { "id": "team-2", "name": "Team Beta", "logoUrl": "..." }
      ]
    }
    ```

### 4.2. Профиль команды

- **Эндпоинт:** `GET /api/v1/teams/{team_id}`
- **Логика:** Этот эндпоинт возвращает полную информацию о команде, включая **полный объект капитана** (`captain`) и **массив полных объектов участников** (`members`).

---

## 5. Пагинация

Все эндпоинты, возвращающие списки, поддерживают пагинацию через query-параметры `page` и `per_page`. Ответ имеет стандартизированную структуру:

```json
{
  "data": [ ... ],
  "meta": {
    "total": 100,
    "page": 1,
    "per_page": 20
  }
}
```

---

## 6. Конфигурация Next.js (`next.config.js`)

- **Важно:** Все внешние хосты, с которых загружаются изображения через компонент `<Image>` (включая ваше S3-хранилище, например, `localhost` для MinIO), должны быть добавлены в `images.remotePatterns`.
- **Перезапуск сервера:** Любые изменения в `next.config.js` требуют **полного перезапуска** сервера разработки.
