# ProDvor: Руководство по интеграции с API

Этот документ объединяет всю необходимую информацию для фронтенд-разработчиков по работе с бэкендом ProDvor.

---

## 1. Основы взаимодействия

- **Базовый URL:** Адрес бэкенда хранится в переменной `NEXT_PUBLIC_API_BASE_URL` в файле `.env`.
- **CORS:** Настроен на стороне бэкенда. Проблем быть не должно.
- **SDK:** Для всех запросов к API используется автоматически сгенерированный клиент, находящийся в `src/shared/api`. Он предоставляет типобезопасные классы (`UsersApi`, `TeamsApi`, и т.д.) и модели данных.
- **Обновление SDK:** При изменении API на бэкенде необходимо обновить локальный `openapi.json` и перегенерировать клиент командой:
  ```bash
  npx openapi-generator-cli generate -i src/docs/openapi.json -g typescript-axios -o src/shared/api
  ```
- **Axios Instance:** Глобальный экземпляр `axios` в `src/shared/api/axios-instance.ts` автоматически управляет добавлением JWT-токенов и их обновлением (refresh).

---

## 2. Авторизация и Управление сессиями

### 2.1. Логин

- **Эндпоинт:** `POST /api/v1/auth/login`
- **Логика:** Бэкенд возвращает **единый JSON-объект**, содержащий `accessToken`, `refreshToken` и полный объект `user`.
    ```json
    {
      "accessToken": "ey...",
      "refreshToken": "ey...",
      "user": { ... }
    }
    ```
- **Действие:** Фронтенд **не делает** дополнительный запрос на `/api/v1/users/me` после логина. Данные пользователя и токены сохраняются в `useUserStore`.

### 2.2. Управление сессиями

- **Эндпоинт:** `GET /api/v1/users/me/sessions`
- **Логика:** Для отображения списка активных сессий (например, в настройках безопасности) фронтенд делает запрос на этот эндпоинт. Бэкенд возвращает массив сессий, помечая текущую флагом `isCurrent: true`.

---

## 3. Загрузка Файлов (Presigned URL)

Для загрузки файлов (аватары, логотипы) используется **трехшаговая система**, чтобы снизить нагрузку на бэкенд и увеличить скорость.

1.  **Запрос разрешения:** Фронтенд отправляет `POST /api/v1/uploads/request-url` с `Content-Type` файла.
2.  **Прямая загрузка в S3:** Фронтенд использует полученные `url` и `fields` для отправки файла напрямую в облачное хранилище (MinIO).
3.  **Уведомление бэкенда:** Фронтенд отправляет финальный `fileUrl` на соответствующий эндпоинт (`POST /api/v1/users/avatar` или `POST /api/v1/teams/:id/logo`) для сохранения ссылки в БД.

**Важно:** Для локальной разработки необходимо настроить и запустить MinIO через Docker. Инструкции находятся в `docs/minio_setup_guide.md`.

---

## 4. Получение данных для профилей

### 4.1. Профиль пользователя

- **Эндпоинт:** `GET /api/v1/users/:id` или `GET /api/v1/users/me`.
- **Параметр:** `?include_teams=true`
- **Логика:** Для получения данных пользователя вместе с его командами всегда используйте параметр `include_teams=true`. Бэкенд вернет объект `user` со встроенным массивом `teams`.
- **Пример ожидаемого ответа:**
    ```json
    {
      "id": "user-1",
      "nickname": "PlayerOne",
      // ... другие поля пользователя
      "player_profile": { ... },
      "teams": [
        { "id": "team-1", "name": "Team Alpha", "logoUrl": "..." },
        { "id": "team-2", "name": "Team Beta", "logoUrl": "..." }
      ]
    }
    ```

### 4.2. Профиль команды

- **Эндпоинт:** `GET /api/v1/teams/:id`
- **Логика:** Этот эндпоинт возвращает полную информацию о команде, включая **полный объект капитана** (`captain`) и **массив полных объектов участников** (`members`).

---

## 5. Конфигурация Next.js (`next.config.js`)

- **Важно:** Все внешние хосты, с которых загружаются изображения через компонент `<Image>` (включая ваше S3-хранилище, например, `localhost` для MinIO), должны быть добавлены в `images.remotePatterns`.
- **Перезапуск сервера:** Любые изменения в `next.config.js` требуют **полного перезапуска** сервера разработки.
